name: Deploy to Server
on:
  push:
    branches:
      - main
      - dev
jobs:
  deploy-to-remote:
    runs-on: ubuntu-latest
    env:
      SHORT_SHA:
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # use github PAT https://bit.ly/3xvOvrF
          token: ${{ secrets.CI_TOKEN }}
          submodules: true

      - name: List files in the repository
        run: ls ${{ github.workspace }}

      # https://bit.ly/3jHvfzd
      # config for main branch
      - name: Configuration for main branch
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          echo "ROOT_PATH=${{ secrets.ROOT_PATH_PRODUCTION }}" >> $GITHUB_ENV

      # config for dev branch
      - name: Configuration for dev branch
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          echo "ROOT_PATH=${{ secrets.ROOT_PATH_STAGING }}" >> $GITHUB_ENV

      # shared config
      - name: Build shared config
        run: |
          SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

          DEPLOY_NAME=release-$GITHUB_RUN_ID-$SHORT_SHA
          echo "DEPLOY_NAME=$DEPLOY_NAME" >> $GITHUB_ENV

          DEPLOY_FOLDER=${{ env.ROOT_PATH }}/${{ env.DEPLOY_NAME }}
          echo "DEPLOY_FOLDER=$DEPLOY_FOLDER" >> $GITHUB_ENV

          USER=${{ secrets.SSH_USER }}
          echo "USER=$USER" >> $GITHUB_ENV

          HOST=${{ secrets.SSH_HOST }}
          echo "HOST=$HOST" >> $GITHUB_ENV

          SRC=${{ github.workspace }}
          echo "SRC=$SRC" >> $GITHUB_ENV

      # ssh-keyscan your.remote.com --> output to git secret KNOWN_HOSTS
      - name: Create SSH key
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts

      - name: List ENV
        run: cat $GITHUB_ENV

      - name: Create deployment folder
        run: ssh ${{ env.USER }}@${{ env.HOST }} -p22 "mkdir -p ${{ env.DEPLOY_FOLDER }} && cd ${{ env.DEPLOY_FOLDER }} && pwd"

      # - name: Deploy with rsync
      #   run: rsync -avz ${{ env.SRC }}/ ${{ env.USER }}@${{ env.HOST }}:${{ env.DEPLOY_FOLDER }}

      # - name: Trigger PHP deployment on remote
      #   run: ssh ${{ env.USER }}@${{ env.HOST }} -p22 "cd $DEPLOY_FOLDER && php -v && ll"
